<!DOCTYPE html>
<html>
<head>
    <title>Quick Sketch Practice Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1e1e1e;
            color: #e0e0e0;
        }
        h1 {
            text-align: center;
            color: #4CAF50;
        }
        .setup-container {
            margin-bottom: 20px;
            padding: 20px;
            background-color: #2d2d2d;
            border-radius: 5px;
        }
        .image-container {
            text-align: center;
            margin-top: 20px;
        }
        .image-container img {
            max-width: 100%;
            max-height: 70vh;
            border: 1px solid #444;
        }
        .timer {
            font-size: 24px;
            margin: 20px 0;
            text-align: center;
            color: #4CAF50;
        }
        .subfolder-header {
            font-size: 20px;
            text-align: center;
            margin-bottom: 15px;
            color: #4CAF50;
            font-weight: bold;
        }
        select, button {
            padding: 8px 12px;
            margin: 5px;
            border-radius: 4px;
            background-color: #333;
            color: #e0e0e0;
            border: 1px solid #555;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }
        .hidden {
            display: none;
        }
        label {
            display: inline-block;
            width: 120px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>Quick Sketch Practice Tool</h1>
    
    <div id="setup" class="setup-container">
        <h2>Setup</h2>
        <div>
            <label for="subfolder">Select category:</label>
            <select id="subfolder">
                {% for subfolder in subfolders %}
                <option value="{{ subfolder }}">{{ subfolder }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label for="timer">Select timer:</label>
            <select id="timer">
                {% for label, seconds in timer_options.items() %}
                <option value="{{ seconds }}" {% if label == default_timer %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
        </div>
        <button id="start-btn">Start Practice</button>
    </div>

    <div id="practice" class="hidden">
        <div class="subfolder-header" id="current-subfolder"></div>
        <div class="timer" id="timer-display"></div>
        <div class="image-container">
            <img id="sketch-image" src="" alt="Sketch reference">
        </div>
        <div class="controls">
            <button id="back-btn">Back</button>
            <button id="next-btn">Next Image</button>
            <button id="stop-btn">Stop Practice</button>
        </div>
    </div>
</body>
<script>
    // Variables to track state
    let currentSubfolder = '';
    let timerDuration = 300; // Default: 5 minutes
    let timerInterval = null;
    let timeRemaining = 0;
    let imageHistory = [];
    let currentImageIndex = -1;
    
    // DOM elements
    const setupDiv = document.getElementById('setup');
    const practiceDiv = document.getElementById('practice');
    const subfolderSelect = document.getElementById('subfolder');
    const timerSelect = document.getElementById('timer');
    const startBtn = document.getElementById('start-btn');
    const backBtn = document.getElementById('back-btn');
    const nextBtn = document.getElementById('next-btn');
    const stopBtn = document.getElementById('stop-btn');
    const timerDisplay = document.getElementById('timer-display');
    const sketchImage = document.getElementById('sketch-image');
    const currentSubfolderDisplay = document.getElementById('current-subfolder');
    
    // Start practice session
    startBtn.addEventListener('click', () => {
        currentSubfolder = subfolderSelect.value;
        timerDuration = parseInt(timerSelect.value);
        
        // Set the subfolder header
        currentSubfolderDisplay.textContent = `Category: ${currentSubfolder}`;
        
        // Reset history
        imageHistory = [];
        currentImageIndex = -1;
        
        // Switch view
        setupDiv.classList.add('hidden');
        practiceDiv.classList.remove('hidden');
        
        // Load first image
        getNextImage();
    });
    
    // Stop practice and return to setup
    stopBtn.addEventListener('click', () => {
        clearInterval(timerInterval);
        setupDiv.classList.remove('hidden');
        practiceDiv.classList.add('hidden');
    });
    
    // Get next image
    nextBtn.addEventListener('click', () => {
        getNextImage();
    });
    
    // Go back to previous image
    backBtn.addEventListener('click', () => {
        if (currentImageIndex > 0) {
            // Pause timer
            clearInterval(timerInterval);
            
            // Show previous image
            currentImageIndex--;
            sketchImage.src = imageHistory[currentImageIndex];
            
            // Update UI
            updateTimerDisplay(0);
        }
    });
    
    // Get a new random image
    function getNextImage() {
        // Clear any existing timer
        clearInterval(timerInterval);
        
        fetch(`/random/${currentSubfolder}`)
            .then(response => response.json())
            .then(data => {
                // Add to history if it's a new image (not going back)
                if (currentImageIndex === imageHistory.length - 1 || imageHistory.length === 0) {
                    imageHistory.push(data.image_url);
                    currentImageIndex = imageHistory.length - 1;
                } else {
                    // We were viewing history, now moving forward
                    currentImageIndex++;
                }
                
                // Display the image
                sketchImage.src = imageHistory[currentImageIndex];
                
                // Start timer if not unlimited
                if (timerDuration > 0) {
                    startTimer();
                } else {
                    updateTimerDisplay(-1); // Show unlimited
                }
            })
            .catch(error => {
                console.error('Error fetching image:', error);
                alert('Error loading image. Please try again.');
            });
    }
    
    // Start the timer
    function startTimer() {
        timeRemaining = timerDuration;
        updateTimerDisplay(timeRemaining);
        
        timerInterval = setInterval(() => {
            timeRemaining--;
            updateTimerDisplay(timeRemaining);
            
            if (timeRemaining <= 0) {
                clearInterval(timerInterval);
                getNextImage();
            }
        }, 1000);
    }
    
    // Update timer display
    function updateTimerDisplay(seconds) {
        if (seconds < 0) {
            timerDisplay.textContent = 'Unlimited time';
            return;
        }
        
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = seconds % 60;
        timerDisplay.textContent = `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
    }
</script>
</html>